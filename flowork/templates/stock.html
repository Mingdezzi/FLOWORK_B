{% extends 'base.html' %}

{% block body_attrs %}
data-analyze-excel-url="{{ url_for('api.analyze_excel') }}"
{% endblock %}

{% block content %}
<div class="mb-4">
     <h2 class="section-title"><i class="bi bi-database-gear me-2"></i>재고 데이터 관리</h2>
     
     {% if not current_user.store_id %}
     <div class="card mb-3 management-section">
        <div class="card-header"><h3 class="mb-0"><i class="bi bi-database-fill-up me-2"></i>상품 데이터 백업 (브랜드 공통)</h3></div>
        <div class="card-body">
            <div class="card-description"><strong>브랜드의 상품 DB 를 엑셀로 백업합니다.</strong><span>매장 재고는 포함되지 않습니다.</span></div>
            <a href="{{ url_for('api.export_db_excel') }}" class="btn btn-success"><i class="bi bi-download me-1"></i>엑셀 다운로드</a>
        </div>
    </div>

    <div class="card mb-3 management-section">
        <div class="card-header"><h3 class="mb-0"><i class="bi bi-database-fill-down me-2"></i>상품 데이터 전체 업로드 (DB 초기화)</h3></div>
        <div class="card-body">
            <div class="card-description"><strong>상품 DB 를 재설정합니다.</strong><span>※경고※ 기존 상품 DB 를 모두 삭제하고, 업로드 된 파일로 재설정 됩니다.</span></div>
            <form action="{{ url_for('api.inventory_upsert') }}" method="POST" enctype="multipart/form-data" class="update-stock-form" id="form-import-db" onsubmit="return confirm('🚨 경고! DB를 덮어씁니다.\n계속하시겠습니까?');">
                <input type="hidden" name="upload_mode" value="db"/>
                <input type="hidden" name="is_full_import" value="true"/>
                <div class="mb-3"><div class="form-check"><input class="form-check-input horizontal-mode-switch" type="checkbox" id="check-import-db" name="is_horizontal"><label class="form-check-label fw-bold" for="check-import-db">가로형 엑셀 파일 여부 체크</label></div></div>
                <div class="mb-3"><label for="db_excel_file" class="form-label file-upload-wrapper" id="wrapper-db-file"><i class="bi bi-file-earmark-excel-fill fs-4"></i><div>파일 선택 (상품 DB)</div><div class="file-status-text" id="status-db-file">엑셀 파일을 선택하세요.</div></label><input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="db_excel_file"></div>
                <div class="column-mapping-grid mb-3" id="grid-import-db">
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label class="text-danger fw-bold">품번*</label><select name="col_pn" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label class="text-danger fw-bold">컬러*</label><select name="col_color" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper conditional-field" data-show-if="vertical"><div class="mapping-item"><label class="text-danger fw-bold">사이즈*</label><select name="col_size" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label>품명</label><select name="col_pname" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label>출시년도</label><select name="col_year" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label>품목</label><select name="col_category" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label>최초가</label><select name="col_oprice" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label>판매가</label><select name="col_sprice" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label>즐겨찾기</label><select name="col_favorite" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                </div>
                <div class="progress-wrapper mb-3" style="display:none;"><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div></div><div class="progress-status text-center mt-1 text-muted small">처리 중...</div></div>
                <button type="submit" class="btn btn-danger"><i class="bi bi-upload me-1"></i>상품 DB 전체 업로드</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="card mb-3 management-section">
        <div class="card-header"><h3 class="mb-0"><i class="bi bi-house-gear me-2"></i>매장재고 UPSERT (추가/수정)</h3></div>
        <div class="card-body">
            <div class="card-description"><strong>매장재고를 업데이트합니다.</strong></div>
            <form action="{{ url_for('api.update_store_stock_excel') }}" method="POST" enctype="multipart/form-data" class="update-stock-form" id="form-update-store" onsubmit="return confirm('엑셀 파일 검증을 시작합니다.\n계속하시겠습니까?');">
                {% if not current_user.store_id %}
                <div class="mb-3 p-3 bg-light border rounded"><label for="target_store_id_main" class="form-label fw-bold text-primary"><i class="bi bi-shop me-1"></i>업데이트 대상 매장 선택</label><select class="form-select" id="target_store_id_main" name="target_store_id" required><option value="">-- 선택 --</option>{% for store in all_stores %}<option value="{{ store.id }}">{{ store.store_name }}</option>{% endfor %}</select></div>
                {% endif %}
                <div class="mb-3"><div class="form-check"><input class="form-check-input horizontal-mode-switch" type="checkbox" id="check-update-store" name="is_horizontal"><label class="form-check-label fw-bold" for="check-update-store">가로형 엑셀 파일 여부 체크</label></div></div>
                <div class="mb-3"><label for="store_stock_excel_file" class="form-label file-upload-wrapper" id="wrapper-store-file"><i class="bi bi-file-earmark-excel-fill fs-4"></i><div>파일 선택 (매장재고)</div><div class="file-status-text" id="status-store-file">엑셀 파일을 선택하세요.</div></label><input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="store_stock_excel_file"></div>
                
                <div class="column-mapping-grid mb-3" id="grid-update-store" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label class="text-danger fw-bold">품번*</label><select name="col_pn" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label class="text-danger fw-bold">컬러*</label><select name="col_color" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper conditional-field" data-show-if="vertical"><div class="mapping-item"><label class="text-danger fw-bold">사이즈*</label><select name="col_size" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper conditional-field" data-show-if="vertical"><div class="mapping-item"><label class="text-danger fw-bold">매장재고*</label><select name="col_store_stock" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    </div>
                
                <div class="progress-wrapper mb-3" style="display:none;"><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div></div><div class="progress-status text-center mt-1 text-muted small">처리 중...</div></div>
                <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-clockwise me-1"></i>검토 및 업데이트</button>
            </form>
        </div>
    </div>
    
    {% if not current_user.store_id %}
    <div class="card mb-3 management-section">
        <div class="card-header"><h3 class="mb-0"><i class="bi bi-building-gear me-2"></i>본사재고 UPSERT (추가/수정)</h3></div>
        <div class="card-body">
            <div class="card-description"><strong>(STOCK_HQ) 본사 재고를 업데이트합니다.</strong></div>
            <form id="form-update-hq-full" class="update-stock-form" action="{{ url_for('api.inventory_upsert') }}" method="POST" enctype="multipart/form-data" onsubmit="return confirm('엑셀 파일 검증을 시작합니다.\n계속하시겠습니까?');">
                <input type="hidden" name="upload_mode" value="hq"/>
                <div class="mb-3"><div class="form-check"><input class="form-check-input horizontal-mode-switch" type="checkbox" id="check-update-hq" name="is_horizontal"><label class="form-check-label fw-bold" for="check-update-hq">가로형 엑셀 파일 여부 체크</label></div></div>
                <div class="mb-3"><label for="hq_stock_excel_file_full" class="form-label file-upload-wrapper" id="wrapper-hq-file-full"><i class="bi bi-file-earmark-excel-fill fs-4"></i><div>파일 선택 (본사재고)</div><div class="file-status-text" id="status-hq-file-full">엑셀 파일을 선택하세요.</div></label><input type="file" name="excel_file" class="form-control" accept=".xlsx, .xls" required id="hq_stock_excel_file_full"></div>
                
                <div class="column-mapping-grid mb-3" id="grid-update-hq-full">
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label class="text-danger fw-bold">품번*</label><select name="col_pn" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper"><div class="mapping-item"><label class="text-danger fw-bold">컬러*</label><select name="col_color" class="form-select form-select-sm" required disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper conditional-field" data-show-if="vertical"><div class="mapping-item"><label class="text-danger fw-bold">사이즈*</label><select name="col_size" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                    <div class="mapping-item-wrapper conditional-field" data-show-if="vertical"><div class="mapping-item"><label class="text-danger fw-bold">본사재고*</label><select name="col_hq_stock" class="form-select form-select-sm" disabled><option value="">-- 열 --</option></select><div class="col-preview"></div></div></div>
                </div>
                <div class="progress-wrapper mb-3" style="display:none;"><div class="progress"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div></div><div class="progress-status text-center mt-1 text-muted small">처리 중...</div></div>
                <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-clockwise me-1"></i>본사재고 업로드</button>
            </form>
        </div>
    </div>

    <div class="card mb-3 management-section">
        <div class="card-header"><h3 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>누락 DB 자동 동기화</h3></div>
        <div class="card-body">
             <div class="card-description"><strong>DB 의 누락된 데이터를 자동으로 동기화 합니다.</strong></div>
            <form action="{{ url_for('api.sync_missing_data') }}" method="POST" onsubmit="return confirm('데이터 동기화를 실행합니다.\n계속하시겠습니까?');">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-info"><i class="bi bi-check2-circle me-1"></i>데이터 동기화 실행</button>
            </form>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="verification-modal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog modal-lg modal-dialog-scrollable"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>데이터 검증: 의심 행 발견</h5></div><div class="modal-body"><div class="alert alert-secondary"><strong><span id="suspicious-count">0</span>개의 행</strong> 확인 필요.</div><div class="table-responsive"><table class="table table-sm table-bordered table-hover" style="font-size: 0.85rem;"><thead class="table-light"><tr><th style="width: 60px;">행 번호</th><th>데이터 미리보기</th><th>의심 사유</th><th style="width: 50px;" class="text-center">제외</th></tr></thead><tbody id="suspicious-rows-tbody"></tbody></table></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" id="btn-cancel-verification" data-bs-dismiss="modal">취소</button><button type="button" class="btn btn-primary" id="btn-confirm-upload"><i class="bi bi-upload me-1"></i> 검토 완료 및 업로드</button></div></div></div></div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/stock.js') }}"></script>
{% endblock %}