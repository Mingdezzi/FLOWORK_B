{% extends 'base.html' %}

{% block content %}
<style>
    .step-indicator { display: flex; justify-content: space-between; padding: 0; margin: 0 0 20px 0; list-style: none; position: relative; }
    .step-indicator::before { content: ''; position: absolute; top: 15px; left: 0; width: 100%; height: 3px; background: #e9ecef; z-index: 1; }
    .step-item { position: relative; z-index: 2; text-align: center; width: 20%; }
    .step-circle { width: 32px; height: 32px; border-radius: 50%; background: #e9ecef; color: #6c757d; line-height: 32px; font-weight: bold; margin: 0 auto 5px; border: 2px solid #fff; transition: all 0.3s; }
    .step-label { font-size: 0.75rem; color: #adb5bd; font-weight: 500; }
    .step-item.active .step-circle { background: #eb6864; color: #fff; transform: scale(1.1); box-shadow: 0 0 0 3px rgba(235, 104, 100, 0.2); }
    .step-item.active .step-label { color: #eb6864; font-weight: bold; }
    .step-item.completed .step-circle { background: #198754; color: #fff; }
    .step-item.completed .step-label { color: #198754; }
</style>

<div class="order-detail-container container my-3"
     data-product-lookup-url="{{ url_for('api.api_find_product_details') }}"
     data-product-search-url="{{ url_for('api.api_order_product_search') }}"
     data-current-color="{{ data.color or '' }}"
     data-current-size="{{ data.size or '' }}"
     data-page-mode="{{ 'view' if is_view_mode else 'edit' }}">
    
    {% if order and order.id %}
    {% set status_map = {'고객주문': 1, '주문등록': 2, '매장도착': 3, '고객연락': 4, '택배 발송': 4, '완료': 5} %}
    {% set current_step = status_map.get(order.order_status, 1) %}
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body pt-4 pb-2">
            <ul class="step-indicator">
                <li class="step-item {{ 'completed' if current_step > 1 else ('active' if current_step == 1 else '') }}"><div class="step-circle"><i class="bi bi-person"></i></div><div class="step-label">주문</div></li>
                 <li class="step-item {{ 'completed' if current_step > 2 else ('active' if current_step == 2 else '') }}"><div class="step-circle"><i class="bi bi-pencil"></i></div><div class="step-label">등록</div></li>
                 <li class="step-item {{ 'completed' if current_step > 3 else ('active' if current_step == 3 else '') }}"><div class="step-circle"><i class="bi bi-box-seam"></i></div><div class="step-label">입고</div></li>
                 <li class="step-item {{ 'completed' if current_step > 4 else ('active' if current_step == 4 else '') }}"><div class="step-circle"><i class="bi bi-telephone"></i></div><div class="step-label">연락/발송</div></li>
                 <li class="step-item {{ 'completed' if current_step > 5 else ('active' if current_step == 5 else '') }}"><div class="step-circle"><i class="bi bi-check-lg"></i></div><div class="step-label">완료</div></li>
            </ul>
        </div>
    </div>
    {% endif %}

    <div class="card mb-3 shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0 fw-bold">
                {% if order and order.id %}<i class="bi bi-info-circle me-1"></i>주문 상세 (No. {{ order.id }}){% else %}<i class="bi bi-plus-circle me-1"></i>신규 주문{% endif %}
            </h6>
        </div>
        <form method="POST" action="{{ url_for('ui.order_detail', order_id=order.id) if order and order.id else url_for('ui.new_order') }}" id="order-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="card-body" id="order-form-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label small text-muted">등록일자</label>
                        <input type="date" class="form-control form-control-sm editable-on-demand" id="created_at" name="created_at" value="{{ (data.created_at or default_created_at).strftime('%Y-%m-%d') if (data or default_created_at) else '' }}" required {{ 'readonly' if is_view_mode else '' }}>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label small text-muted">수령방법</label>
                        <div class="d-flex gap-3 pt-1" id="reception-method-toggles">
                            <div class="form-check">
                                <input class="form-check-input editable-on-demand" type="radio" name="reception_method" id="method_visit" value="방문수령" {{ 'checked' if (not data) or (data and data.reception_method == '방문수령') else '' }} {{ 'disabled' if is_view_mode else '' }}>
                                <label class="form-check-label small" for="method_visit">방문수령</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input editable-on-demand" type="radio" name="reception_method" id="method_delivery" value="택배수령" {{ 'checked' if data and data.reception_method == '택배수령' else '' }} {{ 'disabled' if is_view_mode else '' }}>
                                <label class="form-check-label small" for="method_delivery">택배수령</label>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-3 border-light">
                
                <h6 class="text-primary small fw-bold mb-3"><i class="bi bi-person-fill me-1"></i>고객 정보</h6>
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label small text-muted">고객명</label>
                        <input type="text" class="form-control form-control-sm editable-on-demand" name="customer_name" value="{{ data.customer_name or '' }}" required {{ 'readonly' if is_view_mode else '' }}>
                    </div>
                    <div class="col-6">
                        <label class="form-label small text-muted">연락처</label>
                        <input type="tel" class="form-control form-control-sm editable-on-demand" name="customer_phone" value="{{ data.customer_phone or '' }}" required {{ 'readonly' if is_view_mode else '' }}>
                    </div>
                </div>
                
                <div id="address-fields-wrapper" class="bg-light p-2 rounded mb-3">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" class="form-control editable-on-demand" id="postcode" name="postcode" value="{{ data.postcode or '' }}" placeholder="우편번호" {{ 'readonly' if is_view_mode else '' }}>
                        <button class="btn btn-outline-secondary editable-on-demand" type="button" id="btn-search-address" {{ 'disabled' if is_view_mode else '' }}>검색</button>
                    </div>
                    <input type="text" class="form-control form-control-sm editable-on-demand mb-2" id="address1" name="address1" value="{{ data.address1 or '' }}" placeholder="기본주소" {{ 'readonly' if is_view_mode else '' }}>
                    <input type="text" class="form-control form-control-sm editable-on-demand" id="address2" name="address2" value="{{ data.address2 or '' }}" placeholder="상세주소" {{ 'readonly' if is_view_mode else '' }}>
                </div>

                <h6 class="text-primary small fw-bold mb-3 mt-4"><i class="bi bi-tag-fill me-1"></i>상품 정보</h6>
                <div class="mb-2 position-relative">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control editable-on-demand" id="product_number" name="product_number" value="{{ data.product_number or '' }}" placeholder="품번 검색" required autocomplete="off" {{ 'readonly' if is_view_mode else '' }}>
                        <button class="btn btn-dark editable-on-demand" type="button" id="btn-product-search" {{ 'disabled' if is_view_mode else '' }}><i class="bi bi-search"></i></button>
                    </div>
                    <div id="product-search-results" class="list-group position-absolute w-100 shadow-sm" style="z-index: 1000; max-height: 200px; overflow-y: auto; display: none;"></div>
                </div>
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm bg-light" id="product_name" name="product_name" value="{{ data.product_name or '' }}" readonly>
                </div>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <select class="form-select form-select-sm editable-on-demand" id="color" name="color" required {{ 'disabled' if is_view_mode else '' }}>
                            <option value="">컬러</option>
                            {% if data and data.color %}<option value="{{ data.color }}" selected>{{ data.color }}</option>{% endif %}
                        </select>
                    </div>
                    <div class="col-6">
                        <select class="form-select form-select-sm editable-on-demand" id="size" name="size" required {{ 'disabled' if is_view_mode else '' }}>
                            <option value="">사이즈</option>
                            {% if data and data.size %}<option value="{{ data.size }}" selected>{{ data.size }}</option>{% endif %}
                        </select>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="text-primary small fw-bold mb-0"><i class="bi bi-truck me-1"></i>처리 현황</h6>
                    <button type="button" class="btn btn-xs btn-success editable-on-demand" id="btn-add-processing-row" {{ 'disabled' if is_view_mode else '' }}><i class="bi bi-plus"></i>주문처 추가</button>
                </div>
                
                <table class="table table-sm table-bordered text-center mb-3" style="font-size: 0.85rem;">
                    <thead class="table-light"><tr><th>주문처</th><th>결과</th><th></th></tr></thead>
                    <tbody id="processing-table-body">
                        {% set processing_steps = data.processing_steps.all() if (data and data.id) else (form_data.processing_source | zip(form_data.processing_result)) if form_data else [] %}
                        {% if processing_steps %}
                            {% for step in processing_steps %}
                            <tr>
                                <td><select name="processing_source" class="form-select form-select-sm border-0 editable-on-demand" required {{ 'disabled' if is_view_mode else '' }}><option value="">선택</option>{% for source in order_sources %}<option value="{{ source.id }}" {{ 'selected' if (step.source_store_id == source.id) or (form_data and step[0] | string == source.id | string) else '' }}>{{ source.store_name }}</option>{% endfor %}</select></td>
                                <td>{% set result = step.source_result if (step and step.id) else step[1] if (form_data and step) else '' %}<select name="processing_result" class="form-select form-select-sm border-0"><option value="" {{ 'selected' if not result else '' }}>-</option><option value="완료" {{ 'selected' if result == '완료' else '' }}>완료</option><option value="불가" {{ 'selected' if result == '불가' else '' }}>불가</option></select></td>
                                <td><i class="bi bi-x text-danger btn-delete-row editable-on-demand" style="cursor:pointer;" {{ 'disabled' if is_view_mode else '' }}></i></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td><select name="processing_source" class="form-select form-select-sm border-0 editable-on-demand" required {{ 'disabled' if is_view_mode else '' }}><option value="">선택</option>{% for source in order_sources %}<option value="{{ source.id }}" {{ 'selected' if (step.source_store_id == source.id) or (form_data and step[0] | string == source.id | string) else '' }}>{{ source.store_name }}</option>{% endfor %}</select></td>
                                <td><select name="processing_result" class="form-select form-select-sm border-0"><option value="">-</option><option value="완료">완료</option><option value="불가">불가</option></select></td>
                                <td><i class="bi bi-x text-danger btn-delete-row editable-on-demand" style="cursor:pointer;" {{ 'disabled' if is_view_mode else '' }}></i></td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label small text-muted">현재 상태</label>
                        <select class="form-select form-select-sm fw-bold text-primary" id="order_status" name="order_status" required>
                            {% for status in order_statuses %}
                            <option value="{{ status }}" {{ 'selected' if (data and data.order_status == status) or (not data and status == '고객주문') else '' }}>{{ status }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-6" id="completion-date-wrapper">
                        <label class="form-label small text-muted">완료일</label>
                        <input type="date" class="form-control form-control-sm" id="completed_at" name="completed_at" value="{{ data.completed_at.strftime('%Y-%m-%d') if data and data.completed_at else '' }}">
                    </div>
                </div>
                
                <div id="shipping-fields-wrapper" class="mt-2 p-2 bg-light rounded border">
                    <div class="input-group input-group-sm mb-1">
                        <span class="input-group-text">택배사</span>
                        <input type="text" class="form-control editable-on-demand" name="courier" value="{{ data.courier or '' }}" {{ 'readonly' if is_view_mode else '' }}>
                    </div>
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">송장</span>
                        <input type="text" class="form-control editable-on-demand" name="tracking_number" value="{{ data.tracking_number or '' }}" {{ 'readonly' if is_view_mode else '' }}>
                    </div>
                </div>

                <div class="mt-3">
                    <label class="form-label small text-muted">비고</label>
                    <textarea class="form-control form-control-sm" name="remarks" rows="2">{{ data.remarks or '' }}</textarea>
                </div>
            </div>
            
            <div class="card-footer bg-white border-top-0 pt-0 pb-3">
                <div class="d-grid gap-2 d-flex justify-content-between">
                    {% if order and order.id %}
                        <button type="button" class="btn btn-outline-danger btn-sm" id="btn-delete-order">삭제</button>
                    {% else %}
                        <div></div> 
                    {% endif %}
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('ui.order_list') }}" class="btn btn-secondary btn-sm">목록</a>
                        {% if order and order.id %}
                            <button type="button" class="btn btn-info btn-sm text-white" id="btn-enable-edit" style="{{ 'display:none;' if not is_view_mode else '' }}">수정하기</button>
                            <button type="submit" class="btn btn-primary btn-sm px-4" id="btn-submit-order" style="{{ 'display:none;' if is_view_mode else '' }}">저장</button>
                        {% else %}
                            <button type="submit" class="btn btn-primary btn-sm px-4">등록</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </form>
        {% if order and order.id %}
        <form method="POST" action="{{ url_for('ui.delete_order', order_id=order.id) }}" id="delete-order-form" class="d-none">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        </form>
        {% endif %}
    </div>
</div>

<template id="processing-row-template">
    <tr>
        <td><select name="processing_source" class="form-select form-select-sm border-0 editable-on-demand" required><option value="">선택</option>{% for source in order_sources %}<option value="{{ source.id }}">{{ source.store_name }}</option>{% endfor %}</select></td>
        <td><select name="processing_result" class="form-select form-select-sm border-0"><option value="">-</option><option value="완료">완료</option><option value="불가">불가</option></select></td>
        <td><i class="bi bi-x text-danger btn-delete-row editable-on-demand" style="cursor:pointer;"></i></td>
    </tr>
</template>
{% endblock %}

{% block scripts %}
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="{{ url_for('static', filename='js/common.js') }}"></script>
<script src="{{ url_for('static', filename='js/order.js') }}"></script>
{% endblock %}