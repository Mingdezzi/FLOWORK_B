{% extends 'base.html' %}

{% block body_attrs %}
data-update-stock-url="{{ url_for('api.update_stock') }}"
data-toggle-favorite-url="{{ url_for('api.toggle_favorite') }}"
data-update-actual-stock-url="{{ url_for('api.update_actual_stock') }}"
data-update-product-details-url="{{ url_for('api.api_update_product_details') }}"
data-product-id="{{ product.id }}"
data-my-store-id="{{ my_store_id or 0 }}"
{% endblock %}

{% block content %}
<style>
    /* 상품 상세 전용 스타일 */
    .img-container {
        width: 100%;
        background-color: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
        border: 1px solid #dee2e6;
    }
    .img-container img {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
    }
    .no-image-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #adb5bd;
    }
    .stock-stepper {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
        width: 120px;
        margin: 0 auto;
    }
    .stock-stepper button {
        border: none;
        background: #fff;
        width: 36px;
        height: 36px;
        font-size: 1.2rem;
        color: #495057;
        transition: background 0.2s;
    }
    .stock-stepper button:hover:not(:disabled) {
        background-color: #f1f3f5;
        color: #eb6864;
    }
    .stock-stepper button:disabled {
        color: #dee2e6;
        cursor: not-allowed;
    }
    .stock-stepper .stock-val {
        flex: 1;
        text-align: center;
        font-weight: bold;
        font-size: 1.1rem;
        border-left: 1px solid #f1f3f5;
        border-right: 1px solid #f1f3f5;
        line-height: 36px;
    }
    .hq-stock-badge {
        font-size: 0.9rem;
        padding: 4px 8px;
        border-radius: 4px;
        background-color: #e9ecef;
        color: #495057;
    }
</style>

<div class="container my-4">
    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body p-2">
                    <div class="img-container mb-3">
                        <img src="{{ get_image_url(product) }}" alt="{{ product.product_name }}" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="no-image-placeholder" style="display: none;">
                            <img src="{{ url_for('static', filename='logo.png') }}" style="width: 60px; height: 60px; opacity: 0.3; margin-bottom: 10px;">
                            <span>이미지 없음</span>
                        </div>
                    </div>
                    
                    <div class="product-info px-2">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <div class="text-muted small">{{ product.product_number }}</div>
                                <h4 class="fw-bold mb-1">{{ product.product_name }}</h4>
                            </div>
                            <button id="fav-btn" class="btn btn-link p-0 {{ 'text-warning' if product.is_favorite == 1 else 'text-secondary' }}" style="font-size: 1.5rem;">
                                <i class="bi {{ 'bi-star-fill' if product.is_favorite == 1 else 'bi-star' }}"></i>
                            </button>
                        </div>
                        
                        <div class="d-flex gap-2 text-muted small mb-3">
                            {% if product.release_year %}<span>{{ product.release_year }}년</span>{% endif %}
                            {% if product.item_category %}<span>{{ product.item_category }}</span>{% endif %}
                        </div>

                        {% if variants %}
                            {% set first_variant = variants[0] %}
                            <div class="d-flex align-items-end gap-2">
                                <span class="fs-4 fw-bold text-dark">{{ "{:,d}".format(first_variant.sale_price) }}원</span>
                                {% if first_variant.original_price > first_variant.sale_price %}
                                    <span class="text-decoration-line-through text-muted small mb-1">{{ "{:,d}".format(first_variant.original_price) }}원</span>
                                    <span class="text-danger fw-bold small mb-1">{{ ((1 - (first_variant.sale_price / first_variant.original_price)) * 100) | int }}%</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% if current_user.is_admin and not current_user.store_id %}
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body">
                    <button id="edit-product-btn" class="btn btn-outline-secondary w-100 mb-2 view-field">
                        <i class="bi bi-pencil me-1"></i>상품 정보 수정
                    </button>
                    <div class="edit-field" style="display: none;">
                        <input type="text" id="edit-product-name" class="form-control mb-2" value="{{ product.product_name }}">
                        <div class="row g-2 mb-2">
                            <div class="col"><input type="number" id="edit-release-year" class="form-control" value="{{ product.release_year or '' }}" placeholder="년도"></div>
                            <div class="col"><input type="text" id="edit-item-category" class="form-control" value="{{ product.item_category or '' }}" placeholder="품목"></div>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="save-product-btn" class="btn btn-primary flex-fill">저장</button>
                            <button id="cancel-edit-btn" class="btn btn-secondary flex-fill">취소</button>
                        </div>
                        <form id="delete-product-form" method="POST" action="{{ url_for('api.api_delete_product', product_id=product.id) }}" class="mt-3">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="button" id="delete-product-btn" class="btn btn-outline-danger w-100 btn-sm">상품 삭제</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-lg-7">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="mb-0"><i class="bi bi-boxes me-2"></i>옵션별 재고</h5>
                    {% if all_stores %}
                    <select class="form-select form-select-sm w-auto" id="hq-store-selector">
                        {% for store in all_stores %}
                        <option value="{{ store.id }}" {{ 'selected' if store.id == my_store_id else '' }}>
                            {{ store.store_name }}
                        </option>
                        {% endfor %}
                    </select>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle text-center mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%">컬러</th>
                                    <th style="width: 20%">사이즈</th>
                                    <th style="width: 35%">매장재고</th>
                                    <th style="width: 20%">본사</th>
                                    <th class="view-field" style="display:none; width: 20%;">실사</th> <th class="edit-field" style="display:none;">삭제</th>
                                </tr>
                            </thead>
                            <tbody id="variants-tbody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0 d-flex justify-content-end p-3">
                    <button id="toggle-actual-stock-btn" class="btn btn-secondary btn-sm view-field" style="display: none;">
                        <i class="bi bi-pencil-square me-1"></i>실사 입력
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if related_products %}
    <div class="mt-5">
        <h5 class="mb-3 fw-bold ps-2 border-start border-4 border-primary">이런 상품은 어때요?</h5>
        <div class="row row-cols-2 row-cols-md-4 g-3">
            {% for rel in related_products %}
            <div class="col">
                <a href="{{ url_for('ui.product_detail', product_id=rel.id) }}" class="card h-100 text-decoration-none text-dark border-0 shadow-sm hover-shadow transition-all spa-link">
                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px; overflow: hidden;">
                        <img src="{{ get_image_url(rel) }}" alt="{{ rel.product_name }}" style="max-height: 100%; max-width: 100%;" onerror="this.src='{{ url_for('static', filename='symbol.png') }}'; this.style.opacity='0.2';">
                    </div>
                    <div class="card-body p-2">
                        <div class="small text-muted">{{ rel.product_number }}</div>
                        <div class="fw-bold text-truncate">{{ rel.product_name }}</div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<template id="variant-row-template">
    <tr data-barcode="__BARCODE__" data-variant-id="__VARIANT_ID__">
        <td class="variant-edit-cell">
            <span class="view-field fw-bold">__COLOR__</span>
            <input type="text" class="form-control form-control-sm edit-field" data-field="color" value="__COLOR__" style="display:none;">
        </td>
        <td class="variant-edit-cell">
            <span class="view-field">__SIZE__</span>
            <input type="text" class="form-control form-control-sm edit-field" data-field="size" value="__SIZE__" style="display:none;">
        </td>
        
        <td>
            <div class="__SHOW_IF_MY_STORE__">
                <div class="stock-stepper">
                    <button class="btn-dec" data-barcode="__BARCODE__" data-change="-1"><i class="bi bi-dash"></i></button>
                    <div id="stock-__BARCODE__" class="stock-val __STORE_QTY_CLASS__">__STORE_QTY__</div>
                    <button class="btn-inc" data-barcode="__BARCODE__" data-change="1"><i class="bi bi-plus"></i></button>
                </div>
            </div>
            <div class="__SHOW_IF_NOT_MY_STORE__">
                <span class="fw-bold fs-5 __STORE_QTY_CLASS__">__STORE_QTY__</span>
            </div>
        </td>
        
        <td>
            <span class="hq-stock-badge">__HQ_QTY__</span>
        </td>

        <td class="view-field actual-stock-cell" style="display:none;">
            <div class="input-group input-group-sm __SHOW_IF_MY_STORE__">
                <input type="tel" id="actual-__BARCODE__" class="form-control text-center actual-stock-input" value="__ACTUAL_QTY_VAL__" data-barcode="__BARCODE__" disabled>
                <button class="btn btn-success btn-save-actual" data-barcode="__BARCODE__" disabled><i class="bi bi-check"></i></button>
            </div>
            <span class="badge __DIFF_CLASS__" id="diff-__BARCODE__">__DIFF_VAL__</span>
        </td>
        
        <td class="edit-field" style="display:none;">
            <button class="btn btn-outline-danger btn-sm btn-delete-variant"><i class="bi bi-trash"></i></button>
        </td>
    </tr>
</template>

<template id="add-variant-row-template">
    <tr id="add-variant-row" style="display:none;">
        <td><input type="text" class="form-control form-control-sm" data-field="new-color" placeholder="컬러"></td>
        <td><input type="text" class="form-control form-control-sm" data-field="new-size" placeholder="사이즈"></td>
        <td colspan="4"><button id="btn-add-variant" class="btn btn-success btn-sm w-100"><i class="bi bi-plus"></i> 추가</button></td>
    </tr>
</template>
{% endblock %}

{% block scripts %}
<script>
    window.hqStockData = {{ stock_data_map | tojson }};
    window.allVariants = {{ variants_list_for_json | tojson }};
</script>
<script src="{{ url_for('static', filename='js/detail.js') }}" defer></script>
{% endblock %}