{% extends 'base.html' %}

{% block content %}
<div class="check-container container my-4"
     data-api-fetch-variant-url="{{ url_for('api.api_fetch_variant') }}"
     data-bulk-update-actual-stock-url="{{ url_for('api.bulk_update_actual_stock') }}">

    <h4 class="fw-bold mb-3"><i class="bi bi-upc-scan me-2"></i>재고 실사</h4>

    {% if not current_user.store_id %}
    <div class="card mb-3 border-primary shadow-sm">
        <div class="card-body p-3 bg-light d-flex align-items-center gap-3">
            <i class="bi bi-shop fs-3 text-primary"></i>
            <div class="flex-grow-1">
                <label class="small fw-bold text-primary mb-1">실사 대상 매장 (본사 관리자)</label>
                <select class="form-select form-select-sm border-primary" id="target_store_select">
                    <option value="">-- 매장 선택 --</option>
                    {% for store in all_stores %}
                    <option value="{{ store.id }}">{{ store.store_name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card mb-3 shadow-sm border-0">
        <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
            <h6 class="mb-0 fw-bold">스캔 리스트</h6>
            <button class="btn btn-success btn-sm px-3" id="toggle-scan-btn">
                <i class="bi bi-barcode me-1"></i>리딩 시작
            </button>
        </div>
        <div class="card-body p-0">
            <div class="px-3 pt-3 pb-2">
                <input type="text" class="form-control form-control-lg text-center fw-bold mb-2" id="barcode-input" placeholder="바코드를 스캔하세요" disabled style="letter-spacing: 2px;">
                <div class="d-flex justify-content-between align-items-center small text-muted">
                    <span id="scan-status-msg">대기 중...</span>
                    <span id="scan-total-status">총 0개</span>
                </div>
            </div>
            
            <div class="table-responsive" style="max-height: 50vh; overflow-y: auto;">
                <table class="table table-hover align-middle text-center mb-0" style="font-size: 0.9rem;">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th class="text-start ps-3">상품</th>
                            <th>옵션</th>
                            <th>전산</th>
                            <th>실사</th>
                            <th>차이</th>
                        </tr>
                    </thead>
                    <tbody id="scan-table-body"></tbody>
                </table>
            </div>
        </div>
        <div class="card-footer bg-white border-top-0 d-flex justify-content-between p-3">
            <button class="btn btn-outline-secondary btn-sm" id="clear-scan-btn">목록 초기화</button>
            <button class="btn btn-primary btn-sm px-4 fw-bold" id="submit-scan-btn">실사 반영</button>
        </div>
    </div>

    <div class="d-flex gap-2 justify-content-end">
        <a href="{{ url_for('api.export_stock_check') }}" class="btn btn-outline-success btn-sm" id="btn-export-excel">
            <i class="bi bi-file-earmark-excel me-1"></i>엑셀 저장
        </a>
        <form action="{{ url_for('api.reset_actual_stock') }}" method="POST" id="form-reset-stock" onsubmit="return confirm('경고! 실사 데이터를 모두 삭제하시겠습니까?');" style="margin:0;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="target_store_id" id="reset_target_store_id">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-trash me-1"></i>실사 초기화
            </button>
        </form>
    </div>
</div>

<audio id="sound-success" src="data:audio/wav;base64,UklGRl9vT1dAVEfmtAAAAABAAABwAAABAAIABAA..." preload="auto"></audio>
<audio id="sound-error" src="data:audio/wav;base64,UklGR..." preload="auto"></audio>

<script>
    // 간단한 Beep음 생성
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playBeep(type) {
        if (!audioCtx) return;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'success') {
            osc.frequency.value = 880; 
            osc.type = 'sine';
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        } else {
            osc.frequency.value = 200; 
            osc.type = 'sawtooth';
            gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }
    window.playBeep = playBeep;
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/check.js') }}" defer></script>
{% endblock %}