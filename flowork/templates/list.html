{% extends 'base.html' %}

{% block content %}
<div class="container my-3">
    
    <div class="accordion mb-3 shadow-sm border-0" id="accordionSearch">
        <div class="accordion-item border-0">
            <h2 class="accordion-header">
                <button class="accordion-button {{ 'collapsed' if showing_all else '' }} py-2 px-3 fw-bold bg-white text-dark shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSearch">
                    <i class="bi bi-sliders me-2 text-primary"></i>상세 조건 검색
                </button>
            </h2>
            <div id="collapseSearch" class="accordion-collapse collapse {{ 'show' if not showing_all else '' }}" data-bs-parent="#accordionSearch">
                <div class="accordion-body bg-light p-3">
                    <form action="{{ url_for('ui.list_page') }}" method="GET">
                        <div class="row g-2 mb-2">
                            <div class="col-6 col-md-4">
                                <label class="form-label small text-muted mb-0">품명</label>
                                <input type="text" name="product_name" class="form-control form-control-sm" value="{{ advanced_search_params.get('product_name', '') }}">
                            </div>
                            <div class="col-6 col-md-4">
                                <label class="form-label small text-muted mb-0">품번</label>
                                <input type="text" name="product_number" class="form-control form-control-sm" value="{{ advanced_search_params.get('product_number', '') }}">
                            </div>
                            <div class="col-6 col-md-4">
                                <label class="form-label small text-muted mb-0">품목</label>
                                <select name="item_category" class="form-select form-select-sm">
                                    <option value="">전체</option>
                                    {% for category in filter_options.categories %}
                                    <option value="{{ category }}" {{ 'selected' if advanced_search_params.get('item_category') == category else '' }}>{{ category }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6 col-md-4">
                                <label class="form-label small text-muted mb-0">출시년도</label>
                                <select name="release_year" class="form-select form-select-sm">
                                    <option value="">전체</option>
                                    {% for year in filter_options.years %}
                                    <option value="{{ year }}" {{ 'selected' if advanced_search_params.get('release_year')|string == year|string else '' }}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6 col-md-4">
                                <label class="form-label small text-muted mb-0">색상</label>
                                <select name="color" class="form-select form-select-sm">
                                    <option value="">전체</option>
                                    {% for color in filter_options.colors %}
                                    <option value="{{ color }}" {{ 'selected' if advanced_search_params.get('color') == color else '' }}>{{ color }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6 col-md-4">
                                <label class="form-label small text-muted mb-0">사이즈</label>
                                <select name="size" class="form-select form-select-sm">
                                    <option value="">전체</option>
                                    {% for size in filter_options.sizes %}
                                    <option value="{{ size }}" {{ 'selected' if advanced_search_params.get('size') == size else '' }}>{{ size }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2 mt-3">
                            <a href="{{ url_for('ui.list_page') }}" class="btn btn-sm btn-outline-secondary px-3">초기화</a>
                            <button type="submit" class="btn btn-sm btn-primary px-4">검색</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-2 border-bottom">
            <span class="small text-muted">총 <strong>{{ pagination.total }}</strong>건</span>
        </div>
        <div class="list-group list-group-flush">
            {% for product in products %}
            <a href="{{ url_for('ui.product_detail', product_id=product.id) }}" class="list-group-item list-group-item-action d-flex align-items-center py-2 px-3 spa-link">
                <div class="me-3">
                    <img src="{{ get_image_url(product) }}" alt="" class="img-preview" onerror="this.onerror=null; this.src='{{ url_for('static', filename='symbol.png') }}'; this.style.opacity='0.2';">
                </div>
                <div class="flex-grow-1 overflow-hidden">
                    <div class="d-flex justify-content-between align-items-start">
                        <h6 class="mb-0 fw-bold text-truncate">{{ product.product_name }}</h6>
                        {% set first_variant = product.variants[0] if product.variants else None %}
                        {% if first_variant %}
                            <span class="badge bg-light text-dark border ms-2">{{ "{:,d}".format(first_variant.sale_price) }}</span>
                        {% endif %}
                    </div>
                    <div class="small text-muted text-truncate mt-1">
                        {{ product.product_number }} 
                        {% if product.variants %}
                            <span class="mx-1">|</span> 
                            {% set colors = product.variants | map(attribute='color') | unique | sort | join(', ') %}
                            {{ colors }}
                        {% endif %}
                    </div>
                </div>
            </a>
            {% else %}
            <div class="text-center py-5 text-muted">
                <i class="bi bi-search fs-1 d-block mb-2 text-secondary opacity-50"></i>
                검색된 상품이 없습니다.
            </div>
            {% endfor %}
        </div>
        
        {% if pagination and pagination.total > pagination.per_page %}
        <div class="card-footer bg-white border-top-0 py-3">
            <nav>
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                        <a class="page-link border-0 text-secondary" href="{{ url_for(request.endpoint, page=pagination.prev_num, **advanced_search_params) }}"><i class="bi bi-chevron-left"></i></a>
                    </li>
                    
                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                        {% if page_num %}
                            {% if pagination.page == page_num %}
                                <li class="page-item active"><span class="page-link border-0 fw-bold">{{ page_num }}</span></li>
                            {% else %}
                                <li class="page-item"><a class="page-link border-0 text-secondary" href="{{ url_for(request.endpoint, page=page_num, **advanced_search_params) }}">{{ page_num }}</a></li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled"><span class="page-link border-0 text-muted">...</span></li>
                        {% endif %}
                    {% endfor %}

                    <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                        <a class="page-link border-0 text-secondary" href="{{ url_for(request.endpoint, page=pagination.next_num, **advanced_search_params) }}"><i class="bi bi-chevron-right"></i></a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function imgFallback(img) {
        // 이미지 로드 실패 처리 (기존 로직 유지)
        const src = img.src;
        if (src.includes('_DF_01.jpg')) img.src = src.replace('_DF_01.jpg', '_DM_01.jpg');
        else if (src.includes('_DM_01.jpg')) img.src = src.replace('_DM_01.jpg', '_DG_01.jpg');
        else img.style.opacity = '0.1'; // 최종 실패시 흐리게 처리
    }
</script>
{% endblock %}